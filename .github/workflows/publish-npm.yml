name: Publish JavaScript SDK to npm

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        default: '0.9.0'

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'
        cache-dependency-path: 'bindings/javascript/package-lock.json'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev
    
    - name: Build main SDK
      run: |
        mkdir -p build_release
        cd build_release
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)
    
    - name: Install JavaScript dependencies
      working-directory: bindings/javascript
      run: npm ci
    
    - name: Build JavaScript bindings
      working-directory: bindings/javascript
      run: npm run build
    
    - name: Run JavaScript tests
      working-directory: bindings/javascript
      run: npm test
    
    - name: Update version
      working-directory: bindings/javascript
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          npm version ${{ github.event.inputs.version }} --no-git-tag-version
        else
          # Extract version from release tag
          VERSION=${GITHUB_REF#refs/tags/}
          npm version $VERSION --no-git-tag-version
        fi
    
    - name: Publish to npm
      working-directory: bindings/javascript
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: npm publish --access public
    
    - name: Create release artifacts
      working-directory: bindings/javascript
      run: |
        mkdir -p ../../release_artifacts/javascript
        cp -r build/Release/*.node ../../release_artifacts/javascript/
        cp package.json ../../release_artifacts/javascript/
        cp README.md ../../release_artifacts/javascript/ 2>/dev/null || echo "No README found"
        tar -czf ../../release_artifacts/satox-sdk-javascript-${{ github.event.inputs.version || 'latest' }}.tar.gz -C ../../release_artifacts/javascript .
    
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: javascript-bindings
        path: release_artifacts/
        retention-days: 30 